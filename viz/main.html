<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style type="text/css" media="screen, print">
			body { margin: 30px 50px; font-family: sans-serif; }
		</style>
		<title>Information Visualization project</title>
	</head>
	<body>
		<h1>Global wealth dynamics: Unraveling the evolution and inequality trends</h1>

		<script src="../vendor/d3-7.6.1/dist/d3.js"></script>
		<script>


var margin = {top: 100, right: 100, bottom: 100, left: 100},
    width = 1000 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom;

var x = d3.scaleLinear()
    .range([0, width]);

var yAvgInc = d3.scaleLinear()
    .range([height, 0]);

var yGiniIndex = d3.scaleLinear()
    .range([height, 0])
    .domain([0, 1]);

var svg = d3.select('body')
		.append('div')
		.style('margin-left', '20px')
		.style('margin-bottom', '20px')
		.append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
  	.append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);


async function processTSVFiles() {
	const countriesMap = {};

	const countriesData = await d3.tsv("../data/countries.tsv", d => (
		{
			code: d.code,
			name: d.name,
		}
	));

	countriesData.forEach((d) => countriesMap[d.code] = d.name);

	console.log("countriesMap-----");
	console.log(countriesMap);

	// from now on, we have the mapping of countries' code and name in countriesMap

	const giniIndexData = await d3.tsv("../data/income_gini.tsv", d => (
		{
			code: d.code,
			year: +d.year,
			gini_index: +d.gini_index,
		}
	));

	const incAvgData = await d3.tsv("../data/income_averages.tsv", d => (
		{
			code: d.code,
			year: +d.year,
			average: +d.average,
		}
	));

	// let maxAvgIncYear = d3.max(incAvgData, d => d.year);
	// let maxGiniIndexYear = d3.max(giniIndexData, d => d.year);

	// let maxAbsoluteYear = Math.max(maxAvgIncYear, maxGiniIndexYear);
	// console.log("maxAbsoluteYear: ", maxAbsoluteYear);

	let concatenatedIncAndGini = incAvgData.concat(giniIndexData);
	x.domain(d3.extent(concatenatedIncAndGini, d => d.year));

	yAvgInc.domain(d3.extent(incAvgData, d => d.average));

	// year x-axis
	var xAxis = d3.axisBottom(x)
		.tickFormat(d3.format('d'));
	svg.append('g')
		.attr('transform', `translate(0,${yAvgInc(0)+5})`)
		.call(xAxis);

	// average income (left) y-axis
	var yAxis = d3.axisLeft(yAvgInc);
	svg.append('g')
		.call(yAxis);

	let maxAbsYear = x(d3.max(concatenatedIncAndGini, d => d.year));

	// gini index (right) y-axis
	var yAxis = d3.axisRight(yGiniIndex);
	svg.append('g')
		.attr('transform', `translate(${maxAbsYear + 5})`)
		.call(yAxis);

	// add the 3 axis labels
	svg.append('text')
		.text("Year")
		.attr('transform', `translate(${maxAbsYear / 2}, ${yGiniIndex(0) + 40})`)
		.attr('text-anchor', 'end');

	svg.append('text')
		.text("Average income")
		.attr('transform', `translate(-90, ${yAvgInc(yAvgInc.invert(0) / 1.5)}) rotate(-90)`)
		.attr('text-anchor', 'end');

	svg.append('text')
		.text("Gini index of income")
		.attr('transform', `translate(${maxAbsYear + 60}, ${yGiniIndex(yGiniIndex.invert(0) / 1.75)}) rotate(90)`)
		.attr('text-anchor', 'middle');


	/****** plot lines ******/
	var ts = d3.line()
		.x(d => x(d.year))
		.y(d => yAvgInc(d.average))
		.y(d => yGiniIndex(d.gini_index)); // not sure here

	// just for info: min and max years for average & gini tsv files
	let min = d3.min(incAvgData, d => d.year);
	let max = d3.max(incAvgData, d => d.year);
	console.log("AVERAGE--- min : ", min, " -- max: ", max);

	let min2 = d3.min(giniIndexData, d => d.year);
	let max2 = d3.max(giniIndexData, d => d.year);
	console.log("GINI--- min : ", min2, " -- max: ", max2);

        // Add legend
    const legend = svg.append('g')
        .attr('class', 'legend')
        .attr('transform', `translate(${width / 2 - 60},${height + 75})`);

    legend.append('text')
        .attr('x', -200)
        .text('Average Income');

    legend.append('line')
        .style("stroke", "black")
        .style("stroke-width", 2)
        .attr('x1', -250)
        .attr('y1', -5)
        .attr('x2', -220)
        .attr('y2', -5)

    legend.append('text')
        .attr('x', 200)
        .text('Gini Index');

    legend.append('line')
        .style("stroke-dasharray", ("3, 3"))
        .style("stroke", "black")
        .style("stroke-width", 2)
        .attr('x1', 150)
        .attr('y1', -5)
        .attr('x2', 180)
        .attr('y2', -5)
}

processTSVFiles();

		</script>
	</body>
</html>